<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ESP32 ãƒœã‚¿ãƒ³ç›£è¦–</title>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 50px;
    }

    h1 {
      font-size: 2em;
    }

    #status {
      font-size: 1.8em;
      margin: 20px;
    }

    #time {
      font-size: 1.2em;
      color: #444;
    }

    #elapsed {
      font-size: 1.5em;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>ESP32 ãƒœã‚¿ãƒ³ç›£è¦–</h1>

  <div id="status">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="time"></div>
  <div id="elapsed"></div>

  <script>
    // ===== è¨­å®š =====
    const CHANNEL_ID = "3247896";
    const READ_API_KEY = "4B0IWZ9A8I6MQFZV";
    const FIELD_NUMBER = 1;

    // ===== å¤‰æ•° =====
    let lastEventTimeJST = null;

    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/${FIELD_NUMBER}/last.json?api_key=${READ_API_KEY}`;

    // ===== ThingSpeak ã‹ã‚‰æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆå–å¾— =====
    async function fetchLastEvent() {
      try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.field1 === "1") {
          // UTC â†’ JSTï¼ˆ+9æ™‚é–“ï¼‰
          const utcTime = new Date(data.created_at);
          lastEventTimeJST = new Date(utcTime.getTime());

          document.getElementById("status").textContent =
            "ğŸš¨ æœ€å¾Œã«ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ";

          document.getElementById("time").textContent =
            "æ™‚åˆ»ï¼ˆJSTï¼‰: " + lastEventTimeJST.toLocaleString("ja-JP");
        }
      } catch (error) {
        document.getElementById("status").textContent = "å–å¾—ã‚¨ãƒ©ãƒ¼";
        console.error(error);
      }
    }

    // ===== çµŒéç§’æ•°è¡¨ç¤º =====
    function updateElapsedTime() {
      if (!lastEventTimeJST) return;

      const now = new Date();
      const diffSec = Math.floor((now - lastEventTimeJST) / 1000);

      document.getElementById("elapsed").textContent =
        `æœ€å¾Œã®æŠ¼ä¸‹ã‹ã‚‰ ${diffSec} ç§’çµŒé`;
    }

    // åˆå›å–å¾—
    fetchLastEvent();

    // ThingSpeak ã¯ 15ç§’ã”ã¨
    setInterval(fetchLastEvent, 15000);

    // çµŒéæ™‚é–“ã¯ 1ç§’ã”ã¨
    setInterval(updateElapsedTime, 1000);
  </script>

</body>
</html>

